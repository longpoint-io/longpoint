model MediaContainer {
  id        String               @id @default(cuid(2))
  name      String
  status    MediaContainerStatus
  path      String               @default("/")
  /// The primary media type hosted by the container
  type      MediaType
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  deletedAt DateTime?

  storageUnitId String
  storageUnit   StorageUnit @relation(fields: [storageUnitId], references: [id])

  assets           MediaAsset[]
  searchIndexItems SearchIndexItem[]

  @@unique([path, name])
  @@index([path])
  @@index([status])
  @@index([storageUnitId])
}

model UploadToken {
  id        String   @id @default(cuid(2))
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  mediaAsset   MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
  mediaAssetId String     @unique

  @@index([expiresAt])
}

model MediaAsset {
  id                  String            @id @default(cuid(2))
  variant             MediaAssetVariant @default(PRIMARY)
  status              MediaAssetStatus
  /// Names of the classifiers to run on the uploaded asset after processing
  classifiersOnUpload String[]

  // asset metadata
  mimeType    String
  width       Int?
  height      Int?
  size        Int?
  aspectRatio Float?
  /// Freeform metadata that can be populated by classifiers or manually edited
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  containerId    String
  container      MediaContainer  @relation(fields: [containerId], references: [id], onDelete: Cascade)
  uploadToken    UploadToken?
  classifierRuns ClassifierRun[]

  @@index([containerId, status])
}

enum MediaAssetVariant {
  PRIMARY
  THUMBNAIL
}

enum MediaContainerStatus {
  /// The container is waiting for the original asset to be uploaded
  WAITING_FOR_UPLOAD
  /// One or more variants are being processed
  PROCESSING
  /// The entire container is ready for use
  READY
  /// The original asset failed to upload
  FAILED
  /// One or more variants failed to process, but some are ready for use
  PARTIALLY_FAILED
  /// The container has been soft deleted
  DELETED
}

enum MediaAssetStatus {
  /// The variant is waiting for an asset to be uploaded
  WAITING_FOR_UPLOAD
  /// The variant is being processed
  PROCESSING
  /// The variant is ready for use
  READY
  /// The variant failed to process or be uploaded
  FAILED
}

enum MediaType {
  IMAGE
}
