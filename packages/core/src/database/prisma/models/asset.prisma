model Asset {
  id        String      @id @default(cuid(2))
  name      String
  status    AssetStatus
  /// The primary media type hosted by the asset
  type      AssetType
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  deletedAt DateTime?

  storageUnitId   String
  storageUnit     StorageUnit     @relation(fields: [storageUnitId], references: [id])
  logoForSettings SystemSettings?

  variants         AssetVariant[]
  searchIndexItems SearchIndexItem[]
  collections      AssetCollection[]

  @@index([status])
  @@index([storageUnitId])
}

model AssetCollection {
  assetId      String
  asset        Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([assetId, collectionId])
  @@index([collectionId])
  @@index([assetId])
}

enum AssetStatus {
  /// The asset is waiting for the original variant to be uploaded
  WAITING_FOR_UPLOAD
  /// One or more variants are being processed
  PROCESSING
  /// The entire asset is ready for use
  READY
  /// The original variant failed to upload
  FAILED
  /// One or more variants failed to process, but some are ready for use
  PARTIALLY_FAILED
  /// The asset has been soft deleted
  DELETED
}

model AssetVariant {
  id          String             @id @default(cuid(2))
  type        AssetVariantType   @default(ORIGINAL)
  status      AssetVariantStatus
  /// Entry point file for serving (e.g. "master.m3u8", "video.mp4"). Relative path from variant directory root
  entryPoint  String
  displayName String?

  mimeType    String
  width       Int?
  height      Int?
  size        Int?
  aspectRatio Float?
  duration    Float?
  /// Freeform metadata that can be populated by classifiers or manually edited
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assetId        String
  asset          Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  uploadToken    UploadToken?
  classifierRuns ClassifierRun[]

  @@index([assetId, status])
}

enum AssetVariantType {
  ORIGINAL
  THUMBNAIL
  DERIVATIVE
}

enum AssetVariantStatus {
  /// The variant is waiting for an asset to be uploaded
  WAITING_FOR_UPLOAD
  /// The variant is being processed
  PROCESSING
  /// The variant is ready for use
  READY
  /// The variant failed to process or be uploaded
  FAILED
}

enum AssetType {
  IMAGE
  VIDEO
}

model Collection {
  id          String  @id @default(cuid(2))
  name        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // parentId    String?
  // parent     Collection?                @relation("CollectionHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  // children   Collection[]               @relation("CollectionHierarchy")
  assets AssetCollection[]

  // @@index([parentId])
}

model UploadToken {
  id        String   @id @default(cuid(2))
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  assetVariant   AssetVariant @relation(fields: [assetVariantId], references: [id], onDelete: Cascade)
  assetVariantId String       @unique

  @@index([expiresAt])
}
